{"ast":null,"code":"import \"core-js/modules/es.array.push.js\";\nimport SockJS from 'sockjs-client';\nimport Stomp from 'webstomp-client';\nimport axios from 'axios';\nexport default {\n  data() {\n    return {\n      messages: [],\n      newMessage: \"\",\n      stompClient: null,\n      token: \"\",\n      senderEmail: null,\n      roomId: null\n    };\n  },\n  async created() {\n    this.senderEmail = localStorage.getItem(\"email\");\n    this.roomId = this.$route.params.roomId;\n    const response = await axios.get(`${process.env.VUE_APP_API_BASE_URL}/chat/history/{$this.roomId}`);\n    this.messages = response.data;\n    this.connectWebSocket();\n  },\n  //사용자가 현재 라우트에서 다른 라우트로 이동하려고 할 때 호출되는 훅 함수.\n  beforeRouteLeave(to, from, next) {\n    this.disconnectWebSocket();\n    next();\n  },\n  //화면을 완전히 종료 했을 때\n  beforeUnmount() {\n    this.disconnectWebSocket();\n  },\n  methods: {\n    connectWebSocket() {\n      if (this.stompClient && this.stompClient.connected) return;\n      // sockjs는 websocket을 내장한 향상된 js라이브러리 http엔드포인트 사용.\n      const sockJs = new SockJS(`${process.env.VUE_APP_API_BASE_URL}/connect`);\n      this.stompClient = Stomp.over(sockJs);\n      this.token = localStorage.getItem(\"token\");\n      this.stompClient.connect({\n        Authorization: `Bearer ${this.token}`\n      }, () => {\n        this.stompClient.subscribe(`/topic/${this.roomId}`, message => {\n          const parseMessage = JSON.parse(message.body);\n          this.messages.push(parseMessage);\n          this.scrollToBottom();\n        });\n      });\n    },\n    sendMessage() {\n      if (this.newMessage.trim() === \"\") return;\n      const message = {\n        senderEmail: this.senderEmail,\n        message: this.newMessage\n      };\n      this.stompClient.send(`/publish/${this.roomId}`, JSON.stringify(message));\n      this.newMessage = \"\";\n    },\n    scrollToBottom() {\n      this.$nextTick(() => {\n        const chatBox = this.$el.querySelector(\".chat-box\");\n        chatBox.scrollTop = chatBox.scrollHeight;\n      });\n    },\n    disconnectWebSocket() {\n      if (this.stompClient && this.stompClient.connected) {\n        this.stompClient.unsubscribe(`/topic/${this.roomId}`);\n        this.stompClient.disconnect();\n      }\n    }\n  }\n};","map":{"version":3,"names":["SockJS","Stomp","axios","data","messages","newMessage","stompClient","token","senderEmail","roomId","created","localStorage","getItem","$route","params","response","get","process","env","VUE_APP_API_BASE_URL","connectWebSocket","beforeRouteLeave","to","from","next","disconnectWebSocket","beforeUnmount","methods","connected","sockJs","over","connect","Authorization","subscribe","message","parseMessage","JSON","parse","body","push","scrollToBottom","sendMessage","trim","send","stringify","$nextTick","chatBox","$el","querySelector","scrollTop","scrollHeight","unsubscribe","disconnect"],"sources":["/Users/dengo/Desktop/java/spring_websocket/chat-front/src/views/StompChatPage.vue"],"sourcesContent":["<template>\n  <v-container>\n    <v-row justify=\"center\">\n      <v-col cols=\"12\" md=\"8\">\n        <v-card>\n          <v-card-title class=\"text-center text-h5\">\n            채팅\n          </v-card-title>\n          <v-card-text>\n            <div class=\"chat-box\">\n              <div\n              v-for=\"(msg, index) in messages\"\n              :key=\"index\"\n              :class=\"['chat-message', msg.senderEmail ===this.senderEmail ? 'sent':'received']\"\n              >\n                <strong>{{msg.senderEmail}}: </strong> {{msg.message}}\n              </div>\n            </div>\n            <v-text-field\n              v-model=\"newMessage\"\n              label=\"메시지 입력\"\n              @keyup.enter=\"sendMessage\"\n\n            />\n              <v-btn color=\"primary\" block @click=\"sendMessage\">전송</v-btn>\n          </v-card-text>\n\n        </v-card>\n      </v-col>\n\n    </v-row>\n\n  </v-container>\n</template>\n\n\n<script>\nimport SockJS from 'sockjs-client';\nimport Stomp from 'webstomp-client';\nimport axios from 'axios';\n\nexport default {\n  data(){\n    return{\n      messages: [],\n      newMessage: \"\",\n      stompClient: null,\n      token: \"\",\n      senderEmail: null,\n      roomId: null,\n    }\n  },\n  async created(){\n    this.senderEmail = localStorage.getItem(\"email\");\n    this.roomId = this.$route.params.roomId;\n    const response = await axios.get(`${process.env.VUE_APP_API_BASE_URL}/chat/history/{$this.roomId}`)\n    this.messages = response.data;\n    this.connectWebSocket();\n  },\n  //사용자가 현재 라우트에서 다른 라우트로 이동하려고 할 때 호출되는 훅 함수.\n  beforeRouteLeave(to, from, next) {\n    this.disconnectWebSocket();\n    next();\n  },\n  //화면을 완전히 종료 했을 때\n  beforeUnmount() {\n    this.disconnectWebSocket();\n  },\n  methods:{\n    connectWebSocket(){\n      if(this.stompClient && this.stompClient.connected) return;\n      // sockjs는 websocket을 내장한 향상된 js라이브러리 http엔드포인트 사용.\n      const sockJs = new SockJS(`${process.env.VUE_APP_API_BASE_URL}/connect`)\n      this.stompClient = Stomp.over(sockJs);\n      this.token = localStorage.getItem(\"token\");\n      this.stompClient.connect({\n            Authorization: `Bearer ${this.token}`\n\n          },\n          ()=>{\n            this.stompClient.subscribe(`/topic/${this.roomId}`,(message)=>{\n              const parseMessage = JSON.parse(message.body)\n              this.messages.push(parseMessage);\n              this.scrollToBottom();\n            })\n          }\n\n      )\n    },\n\n    sendMessage(){\n      if(this.newMessage.trim()===\"\")return;\n      const message = {\n        senderEmail: this.senderEmail,\n        message: this.newMessage\n      }\n      this.stompClient.send(`/publish/${this.roomId}`,JSON.stringify(message));\n      this.newMessage=\"\";\n    },\n    scrollToBottom(){\n      this.$nextTick(()=>{\n        const chatBox = this.$el.querySelector(\".chat-box\");\n        chatBox.scrollTop=chatBox.scrollHeight;\n      })\n    },\n    disconnectWebSocket(){\n      if (this.stompClient && this.stompClient.connected) {\n        this.stompClient.unsubscribe(`/topic/${this.roomId}`);\n        this.stompClient.disconnect();\n      }\n    }\n  },\n}\n\n</script>\n<style>\n.chat-box{\n  height: 300px;\n  overflow-y: auto;\n  border: 1px solid #ddd;\n  margin-bottom: 10px;\n\n}\n\n.chat-message{\n  margin-bottom:10px;\n\n}\n\n.sent{\n  text-align: right;\n}\n\n.received{\n  text-align: left;\n}\n</style>"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}